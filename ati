#!/usr/bin/env bash

#########
# Author : Shinichi Okada
# Awesome Terminal Installer
#########

version="0.0.1"
script_name=$(basename "$0")

usage() {
    cat <<EOF
Name: $script_name
Description: Install Homebrew, iTerm2, ZSH, Oh-My-Zsh, Starship, and plugins.

Examples:

    # Install
    ati

    # show help
    ati -h

    # show version
    ati -v
EOF
    exit
}

fn_script_dir() {
    which_install=$(which "$script_name")

    if [[ -L $which_install ]]; then
        # -L file exists and is a symbolic link.
        # check if installation is Homebrew
        # if so use script_dir=/opt/homebrew/Cellar/$0/${version}/bin
        if [[ "$which_install" == *"homebrew"* ]]; then
            script_dir="$(brew --prefix)/Cellar/$0/${version}/bin"
        else
            link=$(realpath "${which_install}")
            script_dir=$(dirname "${link}")
        fi
    else
        script_dir="./"
    fi
    echo $script_dir
}

script_dir=$(fn_script_dir)

import() {
    local file="${script_dir}/lib/${1}"
    if [ -f "${file}" ]; then
        # shellcheck disable=SC1090
        source "${file}"
    else
        echo "Error: Cannot find library at: ${file}"
        exit 1
    fi
}

import utils
import banners

copy_plist() {
    # New check $HOME/Library/Preferences
    preferences=$HOME/Library/Preferences
    plist="com.googlecode.iterm2.plist"
    # json="Awesome-Terminal.json"
    if [[ ! -d "$preferences" ]]; then
        mkdir -p "$preferences"
    fi
    cp "$script_dir/$plist" "$preferences"
    echo "iTerm2 Preferences added."
}

install() {
    echo "Installation starting ..."
    check_brew
    check_iterm
    check_zsh
    check_omz
    check_starship
    # Snazzy color preset is in the com.googlecode.iterms2.plist
    check_firacode
    copy_plist
    add_plugins
    echo "Installation completed."
}

uninstall() {
    echo uninstalling
}

fn_main() {
    if (($# == 0)); then
        install
        exit
    else
        case $1 in
        -u | --uninstall) uninstall ;;
        -h | --help) usage ;;
        -v | --version) echo "${version}" ;;
        *) usage ;;
        esac
    fi
}

# check_os
fn_main "$@"
